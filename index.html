<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Soft Glow Scene – Final Stable</title>
<style>
  body {
    margin:0;
    background:black;
    overflow:hidden;
    height:100vh;
  }

  .scene {
    position:relative;
    width:100%;
    height:100%;
    overflow:hidden;
  }

  /* 소녀 이미지는 항상 유지 */
  .girl {
    position:absolute;
    bottom:15px;
    left:0;
    width:220px;
    z-index:2;
  }

  /* 랜턴 glow */
  .lantern-glow {
    position:absolute;
    bottom:135px;
    left:135px;
    width:60px;
    height:60px;
    border-radius:50%;
    opacity:0;
    filter:blur(25px);
    z-index:4;
    transition:opacity .5s ease, box-shadow .5s ease;
  }

  /* Wire + Bulb 구조 */
  .wire {
    position:absolute;
    top:0;
    width:2px;
    background:rgba(255,255,255,.3);
    transform:translateX(-50%);
    z-index:3;
  }

  .bulb {
    position:absolute;
    top:0;
    width:40px;
    height:40px;
    border-radius:50%;
    border:2px solid rgba(255,255,255,.4);
    transform:translateX(-50%) scale(var(--scale,1));
    display:flex;
    align-items:center;
    justify-content:center;
    opacity:.9;
    z-index:3;
  }

  .bulb-inner {
    width:80%;
    height:80%;
    border-radius:50%;
    background:var(--color);
    box-shadow:0 0 150px var(--color),
               0 0 300px var(--color),
               0 0 500px var(--color);
  }

  .reflection {
    position:absolute;
    top:50%;
    left:50%;
    width:300%;
    height:300%;
    transform:translate(-50%,-50%);
    border-radius:50%;
    pointer-events:none;
    mix-blend-mode:screen;
    filter:blur(25px);
    background:radial-gradient(circle,var(--color)0%,rgba(255,255,255,.05)40%,rgba(0,0,0,0)70%);
  }

  .halo {
    position:absolute;
    left:50%;
    top:50%;
    width:350%;
    height:350%;
    transform:translate(-50%,-50%);
    border-radius:50%;
    pointer-events:none;
    mix-blend-mode:screen;
    filter:blur(35px);
    background:radial-gradient(circle,var(--color)0%,transparent70%);
  }

  .footprints {
    position:absolute;
    bottom:6px;
    left:220px;
    width:calc(100% - 220px);
    height:90px;
    pointer-events:none;
    z-index:4;
  }

  .footprint {
    --fp:hsl(0,100%,60%);
    position:absolute;
    top:20px;
    width:44px;
    height:28px;
    opacity:0;
    mix-blend-mode:screen;
    transition:opacity .6s ease;
  }

  .footprint::before, .footprint::after {
    content:"";
    position:absolute;
    background:var(--fp);
    box-shadow:0 0 8px var(--fp), 0 0 18px var(--fp);
  }

  .footprint::before {
    left:14px;
    top:4px;
    width:30px;
    height:20px;
    border-radius:65% 55% 55% 50%;
  }

  .footprint::after {
    left:0;
    top:6px;
    width:14px;
    height:14px;
    border-radius:50%;
  }

  .footprint.left { transform:rotate(6deg); }
  .footprint.right { transform:rotate(-6deg); }
  .footprint.fade-in { animation:fpIn .4s ease-out forwards; }
  @keyframes fpIn {
    0% { opacity:0; transform:translateY(4px) scale(.92); }
    100% { opacity:.9; transform:translateY(0) scale(1); }
  }

  /* fade 제거용 */
  .fade-remove {
    opacity:0 !important;
    transition:opacity .45s ease;
  }

  canvas {
    position:absolute;
    top:0; left:0;
    z-index:3;
    pointer-events:none;
  }
</style>
</head>
<body>
  <img src="shilloute.png" class="girl">
  <div class="lantern-glow" id="lanternGlow"></div>
  <canvas id="glowCanvas"></canvas>
  <div class="footprints" id="footprints"></div>
  <div class="scene" id="scene"></div>

<script>
window.addEventListener("DOMContentLoaded",()=>{
  const scene=document.getElementById("scene");
  const lantern=document.getElementById("lanternGlow");
  const footprints=document.getElementById("footprints");
  const canvas=document.getElementById("glowCanvas");
  const ctx=canvas.getContext("2d");
  canvas.width=window.innerWidth;
  canvas.height=window.innerHeight;

  let glows=[];
  let animating=true;

  function drawGlows(){
    if(!animating) return;
    ctx.clearRect(0,0,canvas.width,canvas.height);
    for(const g of glows){
      const grad=ctx.createRadialGradient(g.x,g.y,0,g.x,g.y,g.r);
      grad.addColorStop(0,"hsla("+g.h+","+g.s+"%,"+g.l+"%,0.5)");
      grad.addColorStop(0.3,"hsla("+g.h+","+g.s+"%,"+g.l+"%,0.25)");
      grad.addColorStop(1,"transparent");
      ctx.globalCompositeOperation="screen";
      ctx.fillStyle=grad;
      ctx.fillRect(g.x-g.r,g.y-g.r,g.r*2,g.r*2);
    }
    ctx.globalCompositeOperation="source-over";
    requestAnimationFrame(drawGlows);
  }
  drawGlows();

  window.addEventListener("keydown",(e)=>{
    const k=e.key.toLowerCase();
    const colors={
      "1":"hsl(0,100%,60%)","2":"hsl(40,100%,60%)","3":"hsl(60,100%,60%)",
      "4":"hsl(120,100%,60%)","5":"hsl(170,100%,60%)","6":"hsl(240,100%,60%)",
      "7":"hsl(280,100%,60%)"
    };
    const color=colors[k];
    if(!color)return;
    createBulb(color);
    glowLantern(color);
    createFootprint(color);
    setTimeout(fadeLantern,2000);
  });

  function createBulb(color){
    const wire=document.createElement("div");
    wire.className="wire";
    const bulb=document.createElement("div");
    bulb.className="bulb";
    const inner=document.createElement("div");
    inner.className="bulb-inner";
    inner.style.setProperty("--color",color);
    const reflection=document.createElement("div");
    reflection.className="reflection";
    reflection.style.setProperty("--color",color);
    const halo=document.createElement("div");
    halo.className="halo";
    halo.style.setProperty("--color",color);
    bulb.append(inner,reflection,halo);

    const randomX=Math.random()*window.innerWidth*0.8+window.innerWidth*0.1;
    const randomScale=0.7+Math.random()*0.6;
    bulb.style.left=wire.style.left=`${randomX}px`;
    bulb.style.setProperty("--scale",randomScale);
    scene.append(wire,bulb);

    const vh=window.innerHeight;
    const dropDistance=Math.random()*(vh*0.4)+vh*0.2;
    wire.animate([{height:"0px"},{height:dropDistance+"px"}],{duration:1500,easing:"ease-out",fill:"forwards"});
    bulb.animate([{top:"0px"},{top:dropDistance+"px"}],{duration:1500,easing:"ease-out",fill:"forwards"});
  }

  function glowLantern(c){
    lantern.style.background=c;
    lantern.style.boxShadow=`0 0 80px ${c},0 0 160px ${c},0 0 320px ${c}`;
    lantern.style.opacity=0.7;
  }
  function fadeLantern(){
    lantern.style.opacity=0;
    lantern.style.boxShadow="none";
  }

  const stepDistance=110,laneOffset=14,baseTop=10,midShift=0.5,convergeStrength=0.25;
  const minLane=10,rightMargin=120,containerLeft=220,footprintWidth=44;
  let footprintCount=0,lastLeftX=null,lastRightX=null;

  function overflowLimit(){return window.innerWidth-rightMargin-containerLeft;}
  function nextX(isL){return (isL?lastLeftX:lastRightX)===null?(isL?0:stepDistance*midShift):(lastLeftX+stepDistance*(isL?1:midShift));}
  function getLane(x){
    const limit=overflowLimit();
    const p=Math.min(1,x/Math.max(1,limit));
    const taper=(laneOffset-minLane)*convergeStrength;
    return Math.max(minLane,laneOffset-taper*p);
  }

  function createFootprint(color){
    const isLeft=footprintCount%2===0;
    let x=nextX(isLeft);
    const limit=overflowLimit()-footprintWidth;
    if(x>limit){
      fadeOutAndReset();
      footprintCount=0;lastLeftX=lastRightX=null;x=nextX(true);
    }
    const y=baseTop+(isLeft?getLane(x):-getLane(x));
    const fp=document.createElement("div");
    fp.className=`footprint ${isLeft?"left":"right"}`;
    fp.style.setProperty("--fp",color);
    fp.style.left=`${x}px`;
    fp.style.top=`${y}px`;
    footprints.appendChild(fp);
    setTimeout(()=>fp.classList.add("fade-in"),16);

    const hsl=color.match(/\d+/g);
    glows.push({x:x+240,y:window.innerHeight-90+y,r:32,h:hsl[0],s:hsl[1],l:hsl[2]});

    if(isLeft)lastLeftX=x;else lastRightX=x;
    footprintCount++;
  }

  /* ✨ Flicker-free fade + reset */
  function fadeOutAndReset(){
    animating=false;
    const bulbs=[...document.querySelectorAll(".bulb")];
    const wires=[...document.querySelectorAll(".wire")];
    const prints=[...footprints.children];
    const all=[...bulbs,...wires,...prints];

    all.forEach(el=>el.classList.add("fade-remove"));

    setTimeout(()=>{
      glows=[];
      ctx.clearRect(0,0,canvas.width,canvas.height);
      all.forEach(el=>el.remove());
      animating=true;
      requestAnimationFrame(drawGlows);
    },500);
  }
});
</script>
</body>
</html>
